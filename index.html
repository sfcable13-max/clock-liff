<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>公司打卡系統</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Noto Sans TC", sans-serif; margin: 20px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display:flex; align-items:center; gap:12px; }
    img { width: 48px; height: 48px; border-radius: 50%; background:#f2f2f2; }
    button { width: 100%; padding: 14px; margin: 8px 0; border: 0; border-radius: 10px; font-size: 16px; }
    .primary { background:#111; color:#fff; }
    .secondary { background:#f2f2f2; color:#111; }
    .muted { color:#666; font-size: 13px; line-height:1.5; }
    .hidden { display:none; }
    input { width: 100%; padding: 12px; border-radius: 10px; border:1px solid #ccc; font-size: 16px; box-sizing:border-box; }
    .ok { color:#0a7a2f; font-weight:700; }
    .bad{ color:#b00020; font-weight:700; }
  </style>
</head>
<body>
  <h2>公司打卡系統</h2>

  <div class="card">
    <div id="status" class="muted">初始化中…</div>
  </div>

  <div class="card hidden" id="profileCard">
    <div class="row">
      <img id="avatar" alt="avatar" />
      <div>
        <div><b id="displayName"></b></div>
        <div class="muted" id="userId"></div>
      </div>
    </div>
  </div>

  <div class="card hidden" id="bindCard">
    <div><b>第一次使用：請綁定員工編號</b></div>
    <p class="muted">僅需填一次，之後系統會自動辨識你的 LINE 身分。</p>
    <input id="empId" placeholder="輸入員工編號，例如 E001" />
    <button class="primary" id="bindBtn">綁定</button>
    <div class="muted" id="bindHint"></div>
  </div>

  <div class="card hidden" id="qrCard">
    <div><b>請出示 QR 給公司裝置掃描</b></div>
    <div class="muted" id="qrHint">QR 每 5 秒更新一次（截圖無效）</div>

    <div style="margin-top:12px; display:flex; justify-content:center;">
      <div id="qrcode"></div>
    </div>

    <div class="muted" style="margin-top:10px;">
      重新更新倒數：<span id="countdown">5</span> 秒
    </div>

    <div class="muted" style="margin-top:8px;">
      已綁定員工編號：<b id="boundEmpText"></b>
    </div>

    <button class="secondary" id="rebindBtn">更改員工編號</button>
  </div>

  <!-- QR + HMAC -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    /************* 設定 *************/
    const LIFF_ID = "2008804666-dd6swDW3";
    const 密鑰SECRET = "fff3755952"; // 必須與 Apps Script 完全一致
    const 每格秒數 = 5;             // 5 秒一格
    /*******************************/

    let countdownTimer = null;
    let refreshTimer = null;
    let currentProfile = null;

    /************* DOM *************/
    const statusEl = document.getElementById("status");
    const profileCard = document.getElementById("profileCard");
    const bindCard = document.getElementById("bindCard");
    const qrCard = document.getElementById("qrCard");

    const qrContainer = document.getElementById("qrcode");
    const countdownEl = document.getElementById("countdown");
    const qrHint = document.getElementById("qrHint");

    const avatarEl = document.getElementById("avatar");
    const displayNameEl = document.getElementById("displayName");
    const userIdEl = document.getElementById("userId");

    const empIdEl = document.getElementById("empId");
    const bindBtn = document.getElementById("bindBtn");
    const bindHint = document.getElementById("bindHint");

    const boundEmpText = document.getElementById("boundEmpText");
    const rebindBtn = document.getElementById("rebindBtn");

    /************* 小工具 *************/
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setStatus(msg, type=""){
      statusEl.textContent = msg;
      statusEl.className = "muted";
      if(type==="ok") statusEl.className = "ok";
      if(type==="bad") statusEl.className = "bad";
    }
    function isBound(){ return localStorage.getItem("boundEmpId"); }
    function normalizeEmpId(v){ return (v || "").trim(); }

    /************* HMAC（與 Apps Script 一致） *************/
    function 計算簽章(message){
      return CryptoJS.HmacSHA256(message, 密鑰SECRET).toString();
    }
    function 產生Token(profile){
      const empId = isBound();
      if(!empId) throw new Error("尚未綁定員工編號");

      const ts = Math.floor(Date.now() / 1000 / 每格秒數);
      const payload = `uid=${encodeURIComponent(profile.userId)}&emp=${encodeURIComponent(empId)}&ts=${ts}`;
      const sig = 計算簽章(payload);
      return `${payload}&sig=${sig}`;
    }

    /************* QR *************/
    function renderQR(text){
      try{
        if(!qrContainer) throw new Error("找不到 #qrcode 容器");
        if(!window.QRCode) throw new Error("QRCode 套件未載入");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, { text, width: 220, height: 220 });
      }catch(e){
        console.error(e);
        setStatus("無法產生 QR：" + (e.message || e.toString()), "bad");
      }
    }

    function startCountdown(){
      let remain = 每格秒數;
      countdownEl.textContent = remain;

      if(countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        remain--;
        if(remain <= 0) remain = 每格秒數;
        countdownEl.textContent = remain;
      }, 1000);
    }

    function startDynamicQR(profile){
      hide(bindCard);
      show(qrCard);

      const empId = isBound();
      boundEmpText.textContent = empId || "";
      qrHint.textContent = `QR 每 ${每格秒數} 秒更新一次（截圖無效）`;

      function refresh(){
        try{
          const token = 產生Token(profile);
          renderQR(token);
          setStatus("QR 已更新 ✅", "ok");
        }catch(e){
          console.error(e);
          setStatus("QR 產生失敗：" + (e.message || e.toString()), "bad");
        }
      }

      refresh();
      startCountdown();

      if(refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(refresh, 每格秒數 * 1000);
    }

    /************* 綁定 *************/
    bindBtn.addEventListener("click", () => {
      const v = normalizeEmpId(empIdEl.value);
      if(!v){ bindHint.textContent = "請輸入員工編號"; return; }
      localStorage.setItem("boundEmpId", v);
      bindHint.textContent = "綁定成功 ✅";
      if(currentProfile) startDynamicQR(currentProfile);
    });

    rebindBtn.addEventListener("click", () => {
      empIdEl.value = isBound() || "";
      hide(qrCard);
      show(bindCard);
      setStatus("請重新輸入員工編號後按綁定");
    });

    /************* 主流程 *************/
    async function main(){
      try{
        setStatus("初始化 LIFF…");
        await liff.init({ liffId: LIFF_ID });

        if(!liff.isLoggedIn()){
          setStatus("導向 LINE 登入…");
          liff.login();
          return;
        }

        setStatus("讀取個人資料…");
        const profile = await liff.getProfile();
        currentProfile = profile;

        avatarEl.src = profile.pictureUrl || "";
        displayNameEl.textContent = profile.displayName || "";
        userIdEl.textContent = `LINE userId: ${profile.userId}`;
        show(profileCard);

        if(!isBound()){
          setStatus("請先綁定員工編號");
          show(bindCard);
        }else{
          setStatus(`已綁定員工編號：${isBound()}`);
          startDynamicQR(profile);
        }
      }catch(e){
        console.error(e);
        setStatus("初始化失敗：請檢查 LIFF 設定 / Endpoint URL / 網路", "bad");
      }
    }

    main();
  </script>
</body>
</html>


